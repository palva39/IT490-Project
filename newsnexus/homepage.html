<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>News Nexus - Stay Informed</title>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Font Awesome for Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />

    <style>
      body {
        background-color: #f4f7f9;
        font-family: "Arial", sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .content {
        flex: 1;
      }
      .navbar-brand {
        font-size: 1.8rem;
        font-weight: bold;
      }
      .navbar {
        padding: 15px 20px;
      }
      .hero-section {
        background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)),
          url("https://images.unsplash.com/photo-1513475382585-d06e58bcb0e0?w=1600&h=900&fit=crop")
            no-repeat center center/cover;
        color: white;
        padding: 80px 0;
        text-align: center;
      }
      .container-news {
        margin-top: 40px;
      }
      .news-card {
        max-width: 900px;
        margin: auto;
      }
      .news-card img {
        width: 100%;
        height: 300px;
        object-fit: cover;
      }
      .footer {
        padding: 20px 0;
        background: #343a40;
        color: white;
        text-align: center;
        margin-top: auto;
      }
      .rating {
        display: flex;
        gap: 5px;
      }
      .search-section {
        text-align: center;
        margin-top: 30px;
      }
      .search-bar {
        width: 60%;
        max-width: 500px;
        padding: 12px;
        border-radius: 25px;
        border: 1px solid #ccc;
        outline: none;
        transition: all 0.3s ease-in-out;
      }
      .search-bar:focus {
        border-color: #007bff;
        box-shadow: 0px 0px 10px rgba(0, 123, 255, 0.3);
      }
      .search-btn {
        padding: 12px 20px;
        border-radius: 25px;
        margin-left: 10px;
      }
    </style>

    <script>
      let userLoggedIn = false;

      function checkSession() {
        fetch("session_check.php")
          .then((response) => response.json())
          .then((data) => {
            let navbarRight = document.getElementById("navbarRight");
            userLoggedIn = data.loggedIn;

            if (userLoggedIn) {
              navbarRight.innerHTML = `
                            <div class="dropdown">
                                <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-user-circle"></i> ${data.username}
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#">Settings</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="logoutUser()">Logout</a></li>
                                </ul>
                            </div>
                        `;
            } else {
              navbarRight.innerHTML = `<a href="/" class="btn btn-success">Login</a>`;
            }
          })
          .catch((error) => console.error("Session check failed:", error));
      }

      function logoutUser() {
        fetch("logout.php", { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              sessionStorage.clear();
              localStorage.clear();
              window.location.href = "index.html";
            }
          })
          .catch((error) => console.error("Logout failed:", error));
      }

      function fetchNews() {
        const query = document.getElementById("search-query").value.trim();
        if (!query) {
          alert("Please enter a search term.");
          return;
        }

        fetch(`/news_proxy.php?q=${encodeURIComponent(query)}`)
          .then((response) => response.json())
          .then((data) => {
            const newsContainer = document.getElementById("newsContainer");
            newsContainer.innerHTML = "";

            if (data.articles.length > 0) {
              data.articles.forEach((article) => {
                const newsItem = document.createElement("div");
                newsItem.className = "row mb-4";
                newsItem.innerHTML = `
                                <div class="col-12">
                                    <div class="card news-card shadow-lg">
                                        <img src="${
                                          article.urlToImage ||
                                          "https://via.placeholder.com/150"
                                        }" class="card-img-top" alt="News Image">
                                        <div class="card-body">
                                            <h5 class="card-title">${
                                              article.title
                                            }</h5>
                                            <p class="card-text">${
                                              article.description ||
                                              "No description available"
                                            }</p>
                                            <a href="${
                                              article.url
                                            }" target="_blank" class="btn btn-primary">Read More</a>

                                            ${
                                              userLoggedIn
                                                ? `
                                                <div class="mt-3">
                                                    <button class="btn btn-outline-success" onclick="likeArticle('${
                                                      article.url
                                                    }', '${article.title}', '${
                                                    article.url
                                                  }', '${
                                                    article.source.name
                                                  }')">üëç Like</button>
                                                </div>

                                                <div class="rating-section">
                                                    <label class="fw-bold">Rate this article:</label>
                                                    <div id="rating-${
                                                      article.url
                                                    }">
                                                        ${[1, 2, 3, 4, 5]
                                                          .map(
                                                            (star) => `
                                                            <button class="rating-button" onclick="rateArticle('${article.url}', '${article.title}', '${article.url}', ${star}, 'rating-${article.url}')">${star} ‚≠ê</button>
                                                        `
                                                          )
                                                          .join("")}
                                                    </div>
                                                    <p id="selected-rating-${
                                                      article.url
                                                    }" class="selected-rating"></p>
                                                </div>
                                                `
                                                : `<p class="text-danger mt-3">Please log in to like or rate.</p>`
                                            }
                                        </div>
                                    </div>
                                </div>
                            `;
                newsContainer.appendChild(newsItem);
              });
            } else {
              newsContainer.innerHTML = `<p>No articles found for "${query}".</p>`;
            }
          })
          .catch((error) => console.error("Error fetching news:", error));
      }

      function likeArticle(articleId, title, url, category) {
        if (!userLoggedIn) {
          alert("Please log in to like articles.");
          return;
        }

        fetch("/rabbitmq_proxy.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type: "like",
            user: sessionStorage.getItem("username"),
            articleId: articleId,
            title: title,
            url: url,
            category: category || "Uncategorized",
          }),
        })
          .then((response) => response.json())
          .then((data) => alert(data.message))
          .catch((error) => console.error("Error liking article:", error));
      }

      function rateArticle(articleId, title, url, rating) {
        if (!userLoggedIn) {
          alert("Please log in to rate articles.");
          return;
        }

        fetch("/rabbitmq_proxy.php", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            type: "rate",
            user: sessionStorage.getItem("username"),
            articleId: articleId,
            title: title,
            url: url,
            rating: rating,
          }),
        })
          .then((response) => response.json())
          .then((data) => alert(`You rated this article ${rating} stars!`))
          .catch((error) => console.error("Error rating article:", error));
      }

      document.addEventListener("DOMContentLoaded", checkSession);
      window.onload = checkSession;
    </script>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="#"
          ><i class="fas fa-newspaper"></i> News Nexus</a
        >
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav mx-auto">
            <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="#">Trending</a></li>
            <li class="nav-item">
              <a class="nav-link" href="#">Categories</a>
            </li>
          </ul>
          <div id="navbarRight"></div>
        </div>
      </div>
    </nav>

    <header class="hero-section">
      <div class="container">
        <h1 class="hero-title">
          <i class="fas fa-globe"></i> Welcome to News Nexus
        </h1>
        <p class="hero-subtitle">Your Gateway to Trusted, Personalized News</p>
      </div>
    </header>

    <div class="container search-section">
      <h3>Search for News</h3>
      <input
        id="search-query"
        type="text"
        class="search-bar"
        placeholder="e.g. AI advancements, climate change, space exploration..."
      />
      <button class="btn btn-primary search-btn" onclick="fetchNews()">
        Search
      </button>
    </div>

    <div class="container container-news">
      <div class="row mt-3" id="newsContainer"></div>
    </div>

    <footer class="footer">
      <p>&copy; 2025 News Nexus | Your Source for Reliable News</p>
    </footer>
  </body>
</html>
